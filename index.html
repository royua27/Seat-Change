<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9402839498385693"
     crossorigin="anonymous"></script>
    <meta name="naver-site-verification" content="855c6b580d4b201b3053fd13789aeefa0d9043eb" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë¦¬ë°”ê¾¸ê¸° (Smart Seat Manager)</title>
    
    <!-- [Fonts] Pretendard (CDN) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <!-- [Fonts] Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&family=Do+Hyeon&family=Gamja+Flower&family=Grandiflora+One&family=Gugi&family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">

    <style>
        /* * [Design System]
         * v11.1 Professional Edition + User Manual
         */
        :root {
            /* Default Font Stack */
            --base-font: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            
            /* Light Mode */
            --bg-color: #f4f5f9;
            --bg-gradient: linear-gradient(180deg, #ffffff 0%, #f4f5f9 100%);
            --container-bg: #ffffff;
            --text-main: #1b1e26;
            --text-sub: #596070;
            --text-placeholder: #8b95a1;
            
            --primary-color: #3182F6;
            --primary-gradient: linear-gradient(135deg, #3182F6, #005ce3);
            --primary-light: rgba(49, 130, 246, 0.08);
            --primary-text: #3182F6;
            
            --danger-color: #fa4646;
            --warning-color: #ff9e2c;
            --success-color: #27c076;
            
            --border-radius: 20px;
            --input-bg: #f8f9fa;
            --box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
            --card-border: 1px solid rgba(0,0,0,0.06);
            --focus-ring: 0 0 0 3px rgba(49, 130, 246, 0.15);
            
            --transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            
            --tab-bg: rgba(0,0,0,0.04);
            --tab-active-bg: #ffffff;
            --tab-active-shadow: 0 2px 8px rgba(0,0,0,0.06);

            --seat-bg: #ffffff;
            --seat-border: 1px solid #e1e4e8;
            --seat-shadow: 0 2px 6px rgba(0,0,0,0.02);
            
            --modal-bg: #ffffff;
            --blackboard-bg: #2c3e50;
            --blackboard-text: #ffffff;
        }

        /* Dark Mode (Deep Navy) */
        [data-theme="dark"] {
            --bg-color: #111111;
            --bg-gradient: linear-gradient(180deg, #1a1c24 0%, #111111 100%);
            --container-bg: #1e2028;
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --text-placeholder: #52525b;
            
            --primary-color: #4a94ff;
            --primary-gradient: linear-gradient(135deg, #4a94ff, #2563eb);
            --primary-light: rgba(74, 148, 255, 0.1);
            --primary-text: #60a5fa;
            
            --input-bg: #272a33;
            --box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
            --card-border: 1px solid rgba(255,255,255,0.06);
            --focus-ring: 0 0 0 3px rgba(74, 148, 255, 0.25);
            
            --tab-bg: rgba(0,0,0,0.3);
            --tab-active-bg: #32353e;
            --tab-active-shadow: 0 4px 12px rgba(0,0,0,0.4);

            --seat-bg: #272a33;
            --seat-border: 1px solid rgba(255,255,255,0.08);
            --seat-shadow: 0 4px 12px rgba(0,0,0,0.2);
            
            --modal-bg: #272a33;
            --blackboard-bg: #374151;
            --blackboard-text: #e5e7eb;
        }

        * {
            box-sizing: border-box;
            font-family: var(--base-font);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            letter-spacing: -0.02em;
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 120px;
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        /* Header Area */
        .header-wrapper {
            position: relative;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Top Right Controls */
        .top-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: var(--container-bg);
            border: var(--card-border);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            color: var(--text-main);
        }
        .control-btn:hover { transform: translateY(-2px); }
        .control-btn span { pointer-events: none; }

        h1 {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        p.subtitle {
            font-size: 15px;
            color: var(--text-sub);
            margin-bottom: 24px;
            font-weight: 400;
        }

        /* Segmented Tabs */
        .class-tabs {
            display: flex;
            background: var(--tab-bg);
            padding: 5px;
            border-radius: 16px;
            margin-bottom: 36px;
            overflow-x: auto;
            scrollbar-width: none;
            gap: 2px;
            border: var(--card-border);
            backdrop-filter: blur(10px);
        }
        .class-tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            flex: 1 0 auto;
            border: none;
            background: transparent;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
            white-space: nowrap;
            position: relative;
        }
        
        .tab-btn.active {
            background: var(--tab-active-bg);
            color: var(--text-main);
            box-shadow: var(--tab-active-shadow);
        }

        .tab-btn.has-data::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 5px;
            height: 5px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }

        /* Card Styles */
        .card {
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 24px;
            transition: var(--transition);
            border: var(--card-border);
            overflow: hidden;
            position: relative;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 4px 0;
            user-select: none;
        }
        
        .card-header h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-header h2 span {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-sub);
            background: var(--input-bg);
            padding: 2px 8px;
            border-radius: 6px;
        }
        
        .card-content {
            transition: max-height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease, margin-top 0.4s ease;
            max-height: 2000px;
            opacity: 1;
        }
        
        .card.collapsed .card-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            pointer-events: none;
        }
        
        .toggle-icon {
            font-size: 12px;
            color: var(--text-sub);
            transition: transform 0.3s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--input-bg);
        }
        .card.collapsed .toggle-icon { transform: rotate(-90deg); }

        /* Radio Group for Layout */
        .layout-type-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 16px;
            background: var(--input-bg);
            border-radius: 12px;
            transition: var(--transition);
            border: 1px solid transparent;
            color: var(--text-sub);
        }
        .radio-label:hover { background: var(--container-bg); border-color: var(--primary-color); }
        .radio-label input { display: none; }
        .radio-label.checked {
            background: var(--primary-light);
            color: var(--primary-text);
            border-color: var(--primary-color);
        }

        /* Inputs */
        .input-group { display: flex; gap: 12px; margin-bottom: 20px; }
        .input-wrapper { flex: 1; display: flex; flex-direction: column; }

        label {
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid transparent;
            background-color: var(--input-bg);
            border-radius: 14px;
            color: var(--text-main);
            transition: var(--transition);
        }

        input:focus, textarea:focus {
            outline: none;
            background-color: var(--container-bg);
            border-color: var(--primary-color);
            box-shadow: var(--focus-ring);
        }

        textarea { resize: vertical; min-height: 120px; line-height: 1.6; }

        /* Modern Buttons */
        .btn {
            background: var(--primary-gradient);
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(49, 130, 246, 0.25);
            position: relative;
            overflow: hidden;
        }

        .btn-pulse {
            animation: pulse-shadow 3s infinite;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(49, 130, 246, 0.6); }
            70% { box-shadow: 0 0 0 12px rgba(49, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(49, 130, 246, 0); }
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(49, 130, 246, 0.35);
        }
        .btn:active { transform: translateY(0) scale(0.98); }

        .btn-secondary { background: var(--primary-light); color: var(--primary-text); box-shadow: none; }
        .btn-secondary:hover { background: rgba(49, 130, 246, 0.15); box-shadow: none; transform: translateY(-1px); }
        
        .btn-warning { background: rgba(255, 158, 44, 0.1); color: var(--warning-color); box-shadow: none; }
        .btn-warning:hover { background: rgba(255, 158, 44, 0.2); transform: translateY(-1px); }
        .btn-warning.active { background: var(--warning-color); color: #fff; }

        .btn-icon {
            background: var(--input-bg);
            border: var(--card-border);
            width: 42px;
            height: 42px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-main);
            transition: var(--transition);
        }
        .btn-icon:hover { background: var(--container-bg); border-color: var(--text-sub); transform: rotate(-15deg); }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 13px;
            text-decoration: underline;
            cursor: pointer;
            padding: 8px;
            font-weight: 500;
        }
        .btn-text:hover { color: var(--primary-text); }

        /* Info Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        .dash-item {
            background: var(--input-bg);
            border-radius: 14px;
            padding: 12px;
            text-align: center;
            border: var(--card-border);
        }
        .dash-label { font-size: 12px; color: var(--text-sub); display: block; margin-bottom: 4px; }
        .dash-value { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .dash-value.highlight { color: var(--primary-color); }

        /* Grid Area */
        #seat-grid-container {
            overflow-x: auto;
            padding: 10px 10px 30px 10px;
            text-align: center;
            scroll-behavior: smooth;
        }
        #seat-grid-container::-webkit-scrollbar { height: 6px; }
        #seat-grid-container::-webkit-scrollbar-track { background: transparent; }
        #seat-grid-container::-webkit-scrollbar-thumb { background: var(--text-placeholder); border-radius: 10px; }

        .blackboard-area {
            width: 100%;
            max-width: 320px;
            margin: 0 auto 24px auto;
            background-color: var(--blackboard-bg);
            color: var(--blackboard-text);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .seat-grid {
            display: grid;
            gap: 12px;
            min-width: 100%;
            margin-top: 10px;
        }

        .seat {
            position: relative;
            background-color: var(--seat-bg);
            border: var(--seat-border);
            border-radius: 12px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--seat-shadow);
            user-select: none;
        }
        .seat:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            z-index: 5;
            border-color: var(--primary-color);
        }

        .seat.is-locked { border: 2px solid var(--text-main); background-color: var(--seat-bg); }
        .seat.is-locked::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            background: var(--container-bg);
            padding: 1px 5px;
            border-radius: 8px;
            border: var(--seat-border);
            color: var(--text-main);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .seat.is-assigned {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
            color: var(--primary-text);
        }
        
        .seat.pop-animation { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes popIn {
            0% { transform: scale(0.5) translateY(10px); opacity: 0; }
            60% { transform: scale(1.05) translateY(-5px); opacity: 1; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .seat.is-disabled {
            background-color: var(--input-bg);
            border-color: transparent;
            opacity: 0.6; /* ê°€ì‹œì„±ì„ ìœ„í•´ íˆ¬ëª…ë„ ì•½ê°„ ì¡°ì • */
            pointer-events: none;
            box-shadow: none;
        }
        .seat.is-disabled::before {
            content: ''; position: absolute; inset: 6px; border: 2px dashed var(--text-placeholder); border-radius: 12px; opacity: 0.3;
        }
        .seat.is-disabled .seat-exclude-btn { pointer-events: auto; opacity: 1; background: var(--text-sub); color:white; transform:rotate(45deg); }
        
        /* [Modified] Graphic Cross Mark (X) for disabled seats */
        .seat.is-disabled::after {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            
            /* CSS ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ Xì ê·¸ë¦¬ê¸° (ì„  ë‘ê»˜ ì¡°ì ˆ ê°€ëŠ¥) */
            background:
                linear-gradient(to top left, transparent calc(50% - 2px), var(--text-placeholder) calc(50% - 2px), var(--text-placeholder) calc(50% + 2px), transparent calc(50% + 2px)),
                linear-gradient(to top right, transparent calc(50% - 2px), var(--text-placeholder) calc(50% - 2px), var(--text-placeholder) calc(50% + 2px), transparent calc(50% + 2px));
            
            opacity: 0.5;
            /* [Fix] Input(z-index: 1)ë³´ë‹¤ ë†’ê³ , Button(z-index: 20)ë³´ë‹¤ ë‚®ê²Œ ì„¤ì • */
            z-index: 10;
            pointer-events: none;
            /* ì¤‘ì‹¬ì¶•ì„ ê¸°ì¤€ìœ¼ë¡œ ì»¤ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
            transform-origin: center;
            animation: markXPop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes markXPop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.5; }
        }

        .seat.is-selected-swap {
            border: 2px solid var(--warning-color);
            background-color: rgba(255, 158, 44, 0.05);
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 0 4px rgba(255, 158, 44, 0.15);
        }

        .seat-input {
            width: 90%;
            text-align: center;
            font-size: 17px;
            font-weight: 700;
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 0;
            z-index: 1;
        }
        .seat-input:focus { box-shadow: none; border-radius: 0; border-bottom: 2px solid var(--primary-color); }

        .seat-exclude-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--input-bg);
            color: var(--text-sub);
            border: 1px solid rgba(0,0,0,0.05);
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            /* [Fix] ê°€ìœ„í‘œ(z-index: 10)ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
            z-index: 20;
        }
        .seat-exclude-btn:hover { background-color: var(--danger-color); color: white; border-color: transparent; transform: rotate(90deg); }

        /* Gap Cell */
        .gap-cell {
            visibility: hidden;
            pointer-events: none;
        }
        .gap-row-cell {
            height: 40px; /* Vertical gap height */
            grid-column: 1 / -1;
            pointer-events: none;
        }

        /* Custom Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: var(--modal-bg);
            width: 90%;
            max-width: 320px;
            border-radius: 24px;
            padding: 28px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: var(--card-border);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .modal-message { font-size: 15px; color: var(--text-sub); margin-bottom: 24px; line-height: 1.5; }
        
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; transition: var(--transition); }
        .modal-btn.cancel { background: var(--input-bg); color: var(--text-sub); }
        .modal-btn.cancel:hover { background: var(--text-placeholder); color: white; }
        .modal-btn.confirm { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3); }
        .modal-btn.confirm:hover { background: var(--primary-hover); transform: translateY(-2px); }

        /* Manual Modal Specifics */
        #manualModal .modal-card {
            max-width: 480px;
            text-align: left;
            padding: 30px;
        }
        #manualModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        #manualModal .close-icon {
            background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-sub);
        }
        #manualModal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 15px;
            color: var(--text-main);
            line-height: 1.6;
            padding-right: 8px;
        }
        #manualModal .modal-body h3 {
            font-size: 17px;
            margin-top: 24px;
            margin-bottom: 10px;
            color: var(--primary-text);
            font-weight: 700;
        }
        #manualModal .modal-body h3:first-child { margin-top: 0; }
        #manualModal .modal-body ul { padding-left: 20px; margin-bottom: 10px; color: var(--text-sub); }
        #manualModal .modal-body li { margin-bottom: 6px; }
        
        #manualModal .modal-body::-webkit-scrollbar { width: 4px; }
        #manualModal .modal-body::-webkit-scrollbar-thumb { background: var(--text-placeholder); border-radius: 4px; }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 17, 17, 0.85);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s;
            backdrop-filter: blur(8px);
        }
        .loading-overlay.active { opacity: 1; pointer-events: auto; }
        
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary-color);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Dynamic Loading Text */
        .loading-text { font-size: 18px; font-weight: 600; color: white; margin-top: 10px; letter-spacing: -0.01em; }

        /* Confetti Container */
        #confetti-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; overflow: hidden;
        }
        .confetti { position: absolute; width: 8px; height: 8px; opacity: 0; }

        /* Ad Banner */
        .ad-banner {
            width: 100%; 
            /* [Modified] ê´‘ê³  í¬ê¸°ì— ë§ì¶° ìŠ¤íƒ€ì¼ ì¡°ì • (ê¸°ì¡´ í”Œë ˆì´ìŠ¤í™€ë” ìŠ¤íƒ€ì¼ ì œê±°) */
            display: flex; align-items: center; justify-content: center;
            margin: 20px 0;
            padding: 10px 0;
            background: transparent;
        }

        /* [Added] Ad Disclaimer */
        .ad-disclaimer {
            font-size: 11px;
            color: var(--text-placeholder);
            text-align: center;
            margin-top: -16px;
            margin-bottom: 24px;
            opacity: 0.8;
            font-weight: 400;
        }

        /* Toast */
        #toast {
            visibility: hidden; min-width: 200px;
            background: rgba(30, 33, 40, 0.9); color: #fff;
            text-align: center; border-radius: 40px; padding: 12px 24px;
            position: fixed; z-index: 11000; left: 50%; bottom: 60px;
            transform: translateX(-50%) translateY(20px);
            font-size: 14px; font-weight: 500; opacity: 0;
            transition: all 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            /* [Fix] í† ìŠ¤íŠ¸ê°€ ë²„íŠ¼ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì • */
            pointer-events: none;
        }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Footer controls */
        .footer-controls { display: flex; justify-content: center; gap: 20px; margin-top: 40px; font-size: 13px; }
        .footer-btn {
            background: none; border: none; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; gap: 6px; transition: color 0.2s; font-weight: 500;
        }
        .footer-btn:hover { color: var(--primary-color); }

        .hidden { display: none !important; }
        .print-only-date { display: none; }

        @media print {
            /* [Fix] ì¸ì‡„ ì‹œ ë°°ê²½ ë° ìƒ‰ìƒ ê°•ì œ ì ìš© (ì„ ëª…í•˜ê²Œ) */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            body { background: white !important; padding: 0; color: black !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            
            /* ìˆ¨ê¸¸ ìš”ì†Œë“¤ */
            .input-group, .btn, .ad-banner, .ad-disclaimer, .status-bar, footer, .seat-exclude-btn, .card-header, #toast, .btn-text, .class-tabs, .btn-icon, .theme-toggle, .footer-controls, .top-controls, .layout-type-selector { display: none !important; }
            
            /* ì¹´ë“œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (í…Œë‘ë¦¬ ì œê±° ë“±) */
            .card { box-shadow: none; border: none; padding: 0; margin: 0; display: block !important; background: transparent !important; }
            .card-content { max-height: none !important; opacity: 1 !important; display: block !important; }
            
            #step1-container, #step3-container { display: none !important; }
            #step2-container { display: block !important; }
            #seat-grid-container { overflow: visible; padding: 0; }
            
            /* ì¢Œì„ ìŠ¤íƒ€ì¼ (í‘ë°± ì¸ì‡„ ìµœì í™”) */
            .seat {
                background: white !important;
                border: 2px solid #000 !important;
                color: black !important;
                height: 80px;
                box-shadow: none !important;
                border-radius: 8px !important;
            }
            .seat.is-locked { border: 4px solid #000 !important; }
            .seat.is-locked::after { display: none; }
            .seat.is-assigned {
                background: white !important;
                color: black !important;
                border-color: #000 !important;
                font-weight: 900;
            }
            
            /* [Fix] ì¸ì‡„ ì‹œ ì…ë ¥ì°½ ë°°ê²½ ë° ê¸€ììƒ‰ ê°•ì œ ì„¤ì • (ìˆ˜ì •ë¨) */
            .seat-input {
                background-color: white !important;
                font-size: 18pt !important;
                color: black !important;
                font-weight: 900 !important;
                -webkit-text-fill-color: black;
                border: none !important;
                box-shadow: none !important;
            }
            
            /* ì¼ë°˜ input ìš”ì†Œë„ ì¸ì‡„ ì‹œ í°ìƒ‰ ë°°ê²½ ê°•ì œ */
            input { background: white !important; color: black !important; }
            
            .print-only-date { display: block; text-align: center; margin-bottom: 30px; font-size: 16px; color: #000; font-weight: bold; }
            h1 { text-align: center; font-size: 32px; margin-bottom: 10px; color: black !important; display: block !important; }
            .blackboard-area { background: white !important; color: black !important; border: 3px solid #000 !important; }
            .dashboard-grid { display: none !important; }
            p { color: black !important; }
            .gap-cell { display: block !important; border: none !important; }
            .gap-row-cell { height: 20px; } /* ì¤„ì–´ë“  ì„¸ë¡œ ê°„ê²© */
        }
    </style>
</head>
<body>

    <!-- Confetti Canvas (Overlay) -->
    <div id="confetti-container"></div>

    <!-- Loading -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingText" class="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <!-- Custom Modal (Alert/Confirm) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modalTitle">ì•Œë¦¼</div>
            <div class="modal-message" id="modalMessage">ë‚´ìš©</div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <!-- Manual Modal -->
    <div id="manualModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">ì‚¬ìš© ì„¤ëª…ì„œ</div>
                <button class="close-icon" onclick="closeManual()">Ã—</button>
            </div>
            <div class="modal-body">
                <h3>1. ì±…ìƒ ë§ì¶”ê¸° (Step 1)</h3>
                <p>ì›í•˜ëŠ” ë°°ì¹˜ í˜•íƒœ(í˜¼ì, ì§, ëª¨ë‘ )ë¥¼ ì„ íƒí•˜ê³  ì¸ì› ìˆ˜ë‚˜ ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                
                <h3>2. ìë¦¬ ì„¸íŒ…í•˜ê¸° (Step 2)</h3>
                <ul>
                    <li><strong>ê³ ì •ì„ ì§€ì •:</strong> ìë¦¬ì˜ ì…ë ¥ì°½ì— ì´ë¦„ì„ ì§ì ‘ ì…ë ¥í•˜ë©´ 'ê³ ì •ì„'ì´ ë˜ì–´ ëœë¤ ë°°ì • ì‹œ ë°”ë€Œì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                    <li><strong>ìë¦¬ ì œì™¸:</strong> ìš°ì¸¡ ìƒë‹¨ì˜ 'X' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ìë¦¬ëŠ” ë°°ì •ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</li>
                    <li><strong>ì¢Œì„ ë§êµí™˜:</strong> [ì¢Œì„ ë§êµí™˜] ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë‘ ìë¦¬ë¥¼ ì°¨ë¡€ë¡œ í´ë¦­í•˜ë©´ ì„œë¡œ ìœ„ì¹˜ë¥¼ ë°”ê¿‰ë‹ˆë‹¤.</li>
                </ul>

                <h3>3. í•™ìƒ ëª…ë‹¨ ì…ë ¥ (Step 3)</h3>
                <p>ë²ˆí˜¸ìˆœ ë˜ëŠ” ì´ë¦„ìˆœì„ ì„ íƒí•˜ì—¬ ëª…ë‹¨ì„ ì…ë ¥í•˜ì„¸ìš”. 'í…ìŠ¤íŠ¸ ìë™ ì •ë ¬' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì‰¼í‘œë‚˜ ì¤„ë°”ê¿ˆì„ ìë™ìœ¼ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.</p>

                <h3>4. ë°ì´í„° ê´€ë¦¬</h3>
                <p>í•˜ë‹¨ì˜ [ë°ì´í„° ë°±ì—…] ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ì„¤ì •ì„ íŒŒì¼ë¡œ ì €ì¥í•˜ê³ , [ë°ì´í„° ë³µì›]ìœ¼ë¡œ ì–¸ì œë“  ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn confirm" onclick="closeManual()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">ë©”ì‹œì§€</div>
    
    <!-- File Input for Restore -->
    <input type="file" id="restoreInput" accept=".json" style="display:none;" onchange="handleRestoreFile(this)">

    <div class="container">
        <!-- Header & Toggle -->
        <div class="header-wrapper">
            <header>
                <h1>ìë¦¬ ë°”ê¾¸ê¸°</h1>
                <div id="printDate" class="print-only-date"></div>
                <p class="subtitle" id="subtitleText">1ë°˜ì˜ ì¢Œì„ ë°°ì¹˜ì™€ í•™ìƒ ëª…ë‹¨ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </header>
            
            <div class="top-controls">
                <!-- Manual Button -->
                <button class="control-btn" onclick="openManual()" title="ì‚¬ìš© ì„¤ëª…ì„œ">
                    <span style="font-weight:700;">?</span>
                </button>
                <!-- Font Toggle -->
                <button class="control-btn" onclick="cycleFont()" title="ê¸€ê¼´ ë³€ê²½">
                    <span style="font-weight:700;">ê°€</span>
                </button>
                <!-- Theme Toggle -->
                <button class="control-btn" onclick="toggleTheme()" title="í…Œë§ˆ ë³€ê²½">
                    <span id="themeIcon"></span>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="class-tabs">
            <button class="tab-btn active" onclick="switchClass(1)">1ë°˜</button>
            <button class="tab-btn" onclick="switchClass(2)">2ë°˜</button>
            <button class="tab-btn" onclick="switchClass(3)">3ë°˜</button>
            <button class="tab-btn" onclick="switchClass(4)">4ë°˜</button>
            <button class="tab-btn" onclick="switchClass(5)">5ë°˜</button>
            <button class="tab-btn" onclick="switchClass(6)">6ë°˜</button>
            <button class="tab-btn" onclick="switchClass(7)">7ë°˜</button>
            <button class="tab-btn" onclick="switchClass(8)">8ë°˜</button>
        </div>

        <!-- [Modified] ìƒë‹¨ ê´‘ê³  ì˜ì—­ì— ì¹´ì¹´ì˜¤ ì• ë“œí• ì½”ë“œ ì ìš© -->
        <div class="ad-banner">
            <ins class="kakao_ad_area" style="display:none;"
                data-ad-unit = "DAN-DUWchMt8Nl7IRzkr"
                data-ad-width = "728"
                data-ad-height = "90"></ins>
            <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
        </div>
        
        <p class="ad-disclaimer"></p>

        <!-- Step 1 -->
        <section id="step1-container" class="card">
            <div class="card-header" onclick="toggleCard('step1-container')">
                <h2><span>Step 1</span> ì±…ìƒ ë§ì¶”ê¸°</h2>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div class="card-content">
                <div style="margin-top: 24px;">
                    <!-- Layout Mode Selector -->
                    <div class="layout-type-selector">
                        <label class="radio-label"><input type="radio" name="layout" value="solo" onchange="toggleLayoutSettings()"> í˜¼ì ì•‰ê¸°</label>
                        <label class="radio-label checked"><input type="radio" name="layout" value="pair" checked onchange="toggleLayoutSettings()"> ì§ì´ë‘ ì•‰ê¸°</label>
                        <label class="radio-label"><input type="radio" name="layout" value="group" onchange="toggleLayoutSettings()"> ëª¨ë‘  ë§Œë“¤ê¸°</label>
                    </div>

                    <!-- Solo Inputs -->
                    <div id="input-solo" class="input-group hidden">
                        <div class="input-wrapper">
                            <label>ì´ ì±…ìƒ ìˆ˜</label>
                            <input type="number" id="soloTotal" value="30" min="1">
                        </div>
                        <div class="input-wrapper">
                            <label>ì¤„ (ì—´)</label>
                            <input type="number" id="soloCols" value="6" min="1">
                        </div>
                    </div>

                    <!-- Pair Inputs -->
                    <div id="input-pair" class="input-group">
                        <div class="input-wrapper">
                            <label>ê°€ë¡œ (ì—´)</label>
                            <input type="number" id="cols" value="6" min="1" max="10">
                        </div>
                        <div class="input-wrapper">
                            <label>ì„¸ë¡œ (í–‰)</label>
                            <input type="number" id="rows" value="5" min="1" max="10">
                        </div>
                        <div class="input-wrapper">
                            <label>ë¶„ë‹¨ ìˆ˜</label>
                            <input type="number" id="groups" value="3" min="1" max="10">
                        </div>
                    </div>

                    <!-- Group Inputs -->
                    <div id="input-group" class="input-group hidden">
                        <div class="input-wrapper">
                            <label>ì´ ì¸ì› ìˆ˜</label>
                            <input type="number" id="groupTotal" value="24" min="1">
                        </div>
                        <div class="input-wrapper">
                            <label>ëª¨ë‘  ìˆ˜</label>
                            <input type="number" id="groupCount" value="6" min="1">
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="generateGrid()">ì±…ìƒ ë°°ì¹˜ ìƒì„±</button>
                    <div style="text-align: right; margin-top: 12px;">
                        <button class="btn-text" onclick="clearClassData()">í˜„ì¬ ë°˜ ë°ì´í„° ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2 -->
        <section id="step2-container" class="card hidden">
            <div class="card-header">
                <h2><span>Step 2</span> ì¢Œì„ ë°°ì¹˜</h2>
                <div style="display:flex; gap:12px;">
                    <button id="undoBtn" class="btn-icon" onclick="undo()" title="ì‹¤í–‰ ì·¨ì†Œ" style="opacity:0.5; pointer-events:none;">â†º</button>
                    <button id="swapBtn" class="btn btn-warning" style="width: auto; padding: 10px 16px; font-size: 13px;" onclick="toggleSwapMode()">ì¢Œì„ ë§êµí™˜</button>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <div class="dashboard-grid">
                    <div class="dash-item">
                        <span class="dash-label">ì „ì²´ ì¢Œì„</span>
                        <span class="dash-value" id="stat-total">0</span>
                    </div>
                    <div class="dash-item">
                        <span class="dash-label">ë°°ì • ê°€ëŠ¥</span>
                        <span class="dash-value" id="stat-available">0</span>
                    </div>
                    <div class="dash-item">
                        <span class="dash-label">ë°°ì • ì™„ë£Œ</span>
                        <span class="dash-value highlight" id="stat-filled">0</span>
                    </div>
                </div>

                <div class="blackboard-area">
                    <span style="font-size: 20px;"></span> ì¹  íŒ (êµ íƒ)
                </div>

                <div id="seat-grid-container">
                    <div id="seatGrid" class="seat-grid"></div>
                </div>
                
                <p style="text-align: center; font-size: 13px; color: var(--text-placeholder); margin-top: 16px; line-height: 1.6;">
                    â‘  ë°°ì • ì‹œì‘ ì „ì— ìë¦¬ì— ë¯¸ë¦¬ ê°’ì„ ì…ë ¥í•´ë‘˜ ê²½ìš°, ê³ ì •ì„ì´ ì„¤ì •ë©ë‹ˆë‹¤.<br>
                    â‘¡ ìë¦¬ì˜ x í‘œì‹œë¥¼ ëˆ„ë¥¼ ê²½ìš°, í•´ë‹¹ ìë¦¬ëŠ” ë°°ì •ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
                </p>
            </div>
        </section>

        <!-- Step 3 -->
        <section id="step3-container" class="card hidden">
            <div class="card-header" onclick="toggleCard('step3-container')">
                <h2><span>Step 3</span> í•™ìƒ ëª…ë‹¨</h2>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div class="card-content">
                <div style="margin-top: 24px; display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <div style="display:flex; gap:16px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; font-weight:500;">
                            <input type="radio" name="mode" value="number" checked onchange="toggleMode()"> ë²ˆí˜¸ìˆœ
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; font-weight:500;">
                            <input type="radio" name="mode" value="name" onchange="toggleMode()"> ì´ë¦„ìˆœ
                        </label>
                    </div>
                    <button id="cleanBtn" class="btn-text hidden" onclick="cleanNames()" style="color:var(--primary-color);">í…ìŠ¤íŠ¸ ìë™ ì •ë ¬ </button>
                </div>

                <div id="mode-number">
                    <div class="input-wrapper" style="margin-bottom: 16px;">
                        <label>ì´ ì¸ì› ìˆ˜</label>
                        <input type="number" id="totalCount" placeholder="ì˜ˆ: 30" onchange="autoSave()">
                    </div>
                    <div class="input-wrapper">
                        <label>ì œì™¸í•  ë²ˆí˜¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" id="excludeNumbers" placeholder="ì˜ˆ: 5, 12" onchange="autoSave()">
                    </div>
                </div>

                <div id="mode-name" class="hidden">
                    <div class="input-wrapper">
                        <label>í•™ìƒ ì´ë¦„ (ì—”í„°ë¡œ êµ¬ë¶„)</label>
                        <textarea id="nameList" placeholder="ê¹€ì² ìˆ˜&#13;&#10;ì´ì˜í¬" onchange="autoSave()"></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions -->
        <div id="action-area" class="hidden" style="margin-bottom: 40px;">
            <button class="btn btn-pulse" onclick="startArrangement()">
                <span style="font-size: 20px;"></span> ë°°ì • ì‹œì‘
            </button>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="clearOnlyAssigned()">ê²°ê³¼ ì´ˆê¸°í™”</button>
                <button id="printBtn" class="btn btn-secondary hidden" style="flex: 1;" onclick="printResult()"> ì¸ì‡„ / PDF</button>
            </div>
        </div>

        <!-- Footer Data Controls -->
        <div class="footer-controls">
            <button class="footer-btn" onclick="backupData()">
                <span style="font-size:16px;">ğŸ“‚</span> ë°ì´í„° ë°±ì—…
            </button>
            <button class="footer-btn" onclick="document.getElementById('restoreInput').click()">
                <span style="font-size:16px;">Tb</span> ë°ì´í„° ë³µì›
            </button>
        </div>

        <!-- [Modified] í•˜ë‹¨ ê´‘ê³  ì˜ì—­ì— ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ì½”ë“œ ì ìš© -->
        <div class="ad-banner">
            <a href="https://link.coupang.com/a/dnk5jn" target="_blank" referrerpolicy="unsafe-url"><img src="https://ads-partners.coupang.com/banners/955300?subId=&traceId=V0-301-8be2627c04ed5569-I955300&w=728&h=90" alt=""></a>
        </div>
        <p class="ad-disclaimer">"ì´ í¬ìŠ¤íŒ…ì€ ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ í™œë™ì˜ ì¼í™˜ìœ¼ë¡œ, ì´ì— ë”°ë¥¸ ì¼ì •ì•¡ì˜ ìˆ˜ìˆ˜ë£Œë¥¼ ì œê³µë°›ìŠµë‹ˆë‹¤."</p>

    </div>

    <script>
        // --- State Management ---
        let currentClassId = 1;
        let isGridGenerated = false;
        let isSwapMode = false;
        let swapSource = null;
        let historyStack = [];

        // Font List
        const fonts = [
            { name: "Pretendard", family: '"Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif' },
            { name: "Noto Serif Korean", family: '"Noto Serif KR", serif' },
            { name: "Do Hyeon", family: '"Do Hyeon", sans-serif' },
            { name: "Gamja Flower", family: '"Gamja Flower", cursive' },
            { name: "Gugi", family: '"Gugi", cursive' },
            { name: "Bagel Fat One", family: '"Bagel Fat One", system-ui' },
            { name: "Grandiflora One", family: '"Grandiflora One", cursive', weight: 'bold' }
        ];
        let currentFontIndex = 0;

        // --- Init ---
        window.onload = function() {
            initTheme();
            initFont();
            updateTabIndicators();
            loadState(1);
        };

        // --- Theme Management ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            // [Fix] í…Œë§ˆì— ë”°ë¥¸ ì•„ì´ì½˜(ì´ëª¨ì§€) ì¶”ê°€
            icon.innerText = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // --- Font Management ---
        function initFont() {
            const savedFontIndex = localStorage.getItem('fontIndex');
            if (savedFontIndex !== null) {
                currentFontIndex = parseInt(savedFontIndex);
            }
            applyFont();
        }

        function cycleFont() {
            currentFontIndex = (currentFontIndex + 1) % fonts.length;
            localStorage.setItem('fontIndex', currentFontIndex);
            applyFont();
            showToast(`ê¸€ê¼´ì´ '${fonts[currentFontIndex].name}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function applyFont() {
            const font = fonts[currentFontIndex];
            document.documentElement.style.setProperty('--base-font', font.family);
            
            if (font.weight) {
                document.body.style.fontWeight = font.weight;
            } else {
                document.body.style.fontWeight = '';
            }
        }

        // --- Layout Setting Toggles ---
        function toggleLayoutSettings() {
            const radios = document.getElementsByName('layout');
            let selected = 'pair';
            for(const r of radios) {
                if(r.checked) selected = r.value;
                // UI Label Update
                r.parentElement.classList.toggle('checked', r.checked);
            }
            
            document.getElementById('input-solo').classList.add('hidden');
            document.getElementById('input-pair').classList.add('hidden');
            document.getElementById('input-group').classList.add('hidden');
            
            document.getElementById('input-' + selected).classList.remove('hidden');
        }

        // --- Manual Modal ---
        function openManual() {
            document.getElementById('manualModal').classList.add('active');
        }
        function closeManual() {
            document.getElementById('manualModal').classList.remove('active');
        }

        // --- Class Switching ---
        function switchClass(id) {
            if (currentClassId === id) return;
            currentClassId = id;
            
            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                if ((idx + 1) === id) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            
            document.getElementById('subtitleText').innerText = `${id}ë°˜ì˜ ì¢Œì„ ë°°ì¹˜ì™€ í•™ìƒ ëª…ë‹¨ì„ ê´€ë¦¬í•˜ì„¸ìš”`;
            historyStack = [];
            updateUndoBtn();
            loadState(id);
        }

        function updateTabIndicators() {
            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                const classId = idx + 1;
                const raw = localStorage.getItem(`school_seat_v6_class${classId}`);
                if (raw) btn.classList.add('has-data');
                else btn.classList.remove('has-data');
            });
        }

        // --- History / Undo ---
        function pushHistory() {
            if (!isGridGenerated) return;
            if (historyStack.length > 10) historyStack.shift();
            
            const snapshot = {
                seats: Array.from(document.querySelectorAll('.seat')).map(s => ({
                    val: s.querySelector('input').value,
                    dis: s.classList.contains('is-disabled'),
                    lock: s.classList.contains('is-locked'),
                    assign: s.classList.contains('is-assigned')
                }))
            };
            historyStack.push(snapshot);
            updateUndoBtn();
        }

        function undo() {
            if (historyStack.length === 0) return;
            const prev = historyStack.pop();
            const seats = document.querySelectorAll('.seat');
            
            prev.seats.forEach((data, i) => {
                if(seats[i]) {
                    const s = seats[i];
                    const inp = s.querySelector('input');
                    inp.value = data.val;
                    
                    s.classList.remove('is-disabled', 'is-locked', 'is-assigned');
                    inp.disabled = false;

                    if(data.dis) { s.classList.add('is-disabled'); inp.disabled = true; }
                    if(data.lock) s.classList.add('is-locked');
                    if(data.assign) s.classList.add('is-assigned');
                    adjustFontSize(inp);
                }
            });
            updateUndoBtn();
            updateStatus();
            autoSave();
            showToast("ì´ì „ ìƒíƒœë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function updateUndoBtn() {
            const btn = document.getElementById('undoBtn');
            if (historyStack.length > 0) {
                btn.style.opacity = 1;
                btn.style.pointerEvents = 'auto';
            } else {
                btn.style.opacity = 0.5;
                btn.style.pointerEvents = 'none';
            }
        }

        // --- Grid Generation ---
        async function generateGrid(fromLoad = false) {
            if (isGridGenerated && !fromLoad) {
                const ok = await showConfirm("ê·œê²© ì¬ì„¤ì •", "í˜„ì¬ ë°°ì¹˜ê°€ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br>ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if (!ok) return;
            }

            // Determine Layout Mode
            const layoutRadios = document.getElementsByName('layout');
            let layoutMode = 'pair';
            for(const r of layoutRadios) if(r.checked) layoutMode = r.value;

            const gridContainer = document.getElementById('seatGrid');
            gridContainer.innerHTML = '';
            document.getElementById('printBtn').classList.add('hidden');

            let studentIndex = 0;

            if (layoutMode === 'solo') {
                // í˜¼ì ì•‰ê¸°: ë‹¨ìˆœ ê·¸ë¦¬ë“œ
                const total = parseInt(document.getElementById('soloTotal').value) || 30;
                const cols = parseInt(document.getElementById('soloCols').value) || 6;
                const rows = Math.ceil(total / cols);

                gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                const minWidth = cols * 70;
                gridContainer.style.minWidth = `${minWidth}px`;

                for(let i=0; i<total; i++) {
                    createSeatElement(gridContainer, studentIndex++);
                }

            } else if (layoutMode === 'pair') {
                // ì§ì´ë‘ ì•‰ê¸°: ê¸°ì¡´ ë¡œì§
                const rows = parseInt(document.getElementById('rows').value) || 5;
                const cols = parseInt(document.getElementById('cols').value) || 6;
                const groups = parseInt(document.getElementById('groups').value) || 1;
                
                let gridTemplate = '';
                const colsPerGroup = Math.ceil(cols / groups);
                
                for (let i = 0; i < cols; i++) {
                    gridTemplate += '1fr ';
                    if ((i + 1) % colsPerGroup === 0 && i < cols - 1) {
                        gridTemplate += '30px '; // Gap width
                    }
                }
                gridContainer.style.gridTemplateColumns = gridTemplate;
                
                const gapsCount = Math.floor((cols - 1) / colsPerGroup);
                const minWidth = (cols * 70) + (gapsCount * 30);
                gridContainer.style.minWidth = `${minWidth}px`;

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        createSeatElement(gridContainer, studentIndex++);
                        if ((c + 1) % colsPerGroup === 0 && c < cols - 1) {
                            const gap = document.createElement('div');
                            gap.className = 'gap-cell';
                            gridContainer.appendChild(gap);
                        }
                    }
                }

            } else if (layoutMode === 'group') {
                // ëª¨ë‘  ë§Œë“¤ê¸°: ê·¸ë£¹í•‘ ë¡œì§
                const total = parseInt(document.getElementById('groupTotal').value) || 24;
                const groupCount = parseInt(document.getElementById('groupCount').value) || 6;
                
                // ëª¨ë‘  ë‹¹ ì¸ì› (ì§ìˆ˜ ë§ì¶¤ ê¶Œì¥)
                const perGroup = Math.ceil(total / groupCount);
                const rowsPerGroup = Math.ceil(perGroup / 2); // 2ì—´ ì¢…ëŒ€ ê¸°ì¤€
                
                // ê°€ë¡œì— ë°°ì¹˜í•  ëª¨ë‘  ìˆ˜ ê³„ì‚° (ìë™)
                let groupsPerRow = 3;
                if (groupCount <= 2) groupsPerRow = groupCount;
                else if (groupCount === 4) groupsPerRow = 2;
                else if (groupCount >= 7) groupsPerRow = 4;
                
                const groupsPerCol = Math.ceil(groupCount / groupsPerRow);

                // ê·¸ë¦¬ë“œ ì„¤ì •
                // ê° ëª¨ë‘ ì€ 2ì¹¸(ì±…ìƒ) + 1ì¹¸(ê°„ê²©) ì°¨ì§€
                let gridTemplate = '';
                for(let g=0; g<groupsPerRow; g++) {
                    gridTemplate += '1fr 1fr '; // ì±…ìƒ 2ê°œ
                    if (g < groupsPerRow - 1) gridTemplate += '40px '; // ëª¨ë‘  ê°„ ê°€ë¡œ ê°„ê²©
                }
                gridContainer.style.gridTemplateColumns = gridTemplate;
                
                // ì „ì²´ ë„ˆë¹„ ê³„ì‚°
                const minWidth = (groupsPerRow * 2 * 70) + ((groupsPerRow - 1) * 40);
                gridContainer.style.minWidth = `${minWidth}px`;

                // ëª¨ë‘  ë°°ì¹˜ Loop
                for (let gy = 0; gy < groupsPerCol; gy++) {
                    for (let r = 0; r < rowsPerGroup; r++) {
                        for (let gx = 0; gx < groupsPerRow; gx++) {
                            // í˜„ì¬ ëª¨ë‘  ë²ˆí˜¸
                            const currentGroupIndex = (gy * groupsPerRow) + gx;
                            
                            // ì±…ìƒ 2ê°œ (ì™¼ìª½, ì˜¤ë¥¸ìª½)
                            for (let k = 0; k < 2; k++) {
                                // í˜„ì¬ ëª¨ë‘  ë‚´ ì¢Œì„ ì¸ë±ìŠ¤
                                const seatInGroupIndex = (r * 2) + k;
                                
                                if (currentGroupIndex < groupCount && seatInGroupIndex < perGroup) {
                                    createSeatElement(gridContainer, studentIndex++);
                                    // [Modified] Add group index to dataset
                                    gridContainer.lastElementChild.dataset.group = currentGroupIndex; 
                                } else {
                                    // ë¹ˆ ê³µê°„ (ëª¨ë‘  ì¸ì›ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ëª¨ë‘ ì´ ì—†ëŠ” ê³³)
                                    const gap = document.createElement('div');
                                    gap.className = 'gap-cell'; // íˆ¬ëª… ì²˜ë¦¬
                                    gridContainer.appendChild(gap);
                                }
                            }

                            // ê°€ë¡œ ëª¨ë‘  ê°„ê²©
                            if (gx < groupsPerRow - 1) {
                                const gap = document.createElement('div');
                                gap.className = 'gap-cell';
                                gridContainer.appendChild(gap);
                            }
                        }
                    }
                    // ì„¸ë¡œ ëª¨ë‘  ê°„ê²© (í–‰ ì „ì²´)
                    if (gy < groupsPerCol - 1) {
                        const rowGap = document.createElement('div');
                        rowGap.className = 'gap-row-cell';
                        gridContainer.appendChild(rowGap);
                    }
                }
            }

            const wrapper = document.getElementById('seat-grid-container');
            wrapper.style.display = 'block';
            ['step2-container', 'step3-container', 'action-area'].forEach(id => 
                document.getElementById(id).classList.remove('hidden')
            );
            
            isGridGenerated = true;
            updateStatus();

            if (!fromLoad) {
                pushHistory();
                document.getElementById('step1-container').classList.add('collapsed');
                autoSave();
            }
        }

        // Helper function for creating seat
        function createSeatElement(container, index) {
            const cell = document.createElement('div');
            cell.className = 'seat';
            cell.dataset.index = index;
            cell.onclick = (e) => handleSeatClick(e, cell);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'seat-input';
            input.addEventListener('input', (e) => {
                adjustFontSize(e.target);
                checkLocked(e);
                updateStatus();
                autoSave();
            });

            const btn = document.createElement('button');
            btn.className = 'seat-exclude-btn';
            btn.innerHTML = 'âœ•';
            btn.onclick = (e) => { e.stopPropagation(); toggleExclude(cell); };

            cell.appendChild(input);
            cell.appendChild(btn);
            container.appendChild(cell);
        }

        function adjustFontSize(input) {
            const len = input.value.length;
            if (len > 4) input.style.fontSize = "14px";
            else if (len > 3) input.style.fontSize = "16px";
            else input.style.fontSize = "18px";
        }

        function updateStatus() {
            if (!isGridGenerated) return;
            const seats = document.querySelectorAll('.seat');
            let total = seats.length;
            let excluded = 0;
            let filled = 0;

            seats.forEach(seat => {
                if (seat.classList.contains('is-disabled')) excluded++;
                else {
                    const val = seat.querySelector('input').value.trim();
                    if (val !== "") filled++;
                }
            });

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-available').innerText = total - excluded;
            document.getElementById('stat-filled').innerText = filled;
        }

        // --- Interactions ---
        function toggleExclude(cell) {
            pushHistory();
            const input = cell.querySelector('input');
            const isDisabled = cell.classList.contains('is-disabled');
            
            if (isDisabled) {
                cell.classList.remove('is-disabled');
                input.disabled = false;
            } else {
                cell.classList.add('is-disabled');
                input.value = '';
                input.disabled = true;
                cell.classList.remove('is-locked', 'is-assigned');
            }
            updateStatus();
            autoSave();
        }

        function checkLocked(e) {
            const cell = e.target.parentElement;
            if (e.target.value.trim() !== "") {
                cell.classList.add('is-locked');
                cell.classList.remove('is-assigned');
            } else {
                cell.classList.remove('is-locked');
            }
        }

        function toggleSwapMode() {
            isSwapMode = !isSwapMode;
            const btn = document.getElementById('swapBtn');
            const seats = document.querySelectorAll('.seat');
            const inputs = document.querySelectorAll('.seat-input');
            
            if (isSwapMode) {
                btn.classList.add('active');
                btn.innerText = "ì·¨ì†Œ";
                seats.forEach(s => s.style.cursor = "pointer");
                inputs.forEach(inp => inp.style.pointerEvents = 'none');
                showToast("ë§êµí™˜í•  ë‘ ì¢Œì„ì„ ì°¨ë¡€ë¡œ ì„ íƒí•˜ì„¸ìš”");
            } else {
                btn.classList.remove('active');
                btn.innerText = "ì¢Œì„ ë§êµí™˜";
                swapSource = null;
                seats.forEach(s => {
                    s.style.cursor = "default";
                    s.classList.remove('is-selected-swap');
                });
                inputs.forEach(inp => inp.style.pointerEvents = 'auto');
            }
        }

        function handleSeatClick(e, cell) {
            if (!isSwapMode || e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            if (cell.classList.contains('is-disabled')) return;

            if (!swapSource) {
                swapSource = cell;
                cell.classList.add('is-selected-swap');
            } else {
                if (swapSource === cell) {
                    swapSource.classList.remove('is-selected-swap');
                    swapSource = null;
                    return;
                }
                
                pushHistory();
                const in1 = swapSource.querySelector('input');
                const in2 = cell.querySelector('input');
                [in1.value, in2.value] = [in2.value, in1.value];
                
                [swapSource, cell].forEach(s => {
                    s.classList.remove('is-selected-swap');
                    const v = s.querySelector('input').value.trim();
                    if(v && !s.classList.contains('is-locked')) s.classList.add('is-assigned');
                    else if(!v) s.classList.remove('is-assigned');
                    adjustFontSize(s.querySelector('input'));
                });

                swapSource = null;
                showToast("ì¢Œì„ì´ êµí™˜ë˜ì—ˆìŠµë‹ˆë‹¤");
                updateStatus();
                autoSave();
                toggleSwapMode();
            }
        }

        // --- Logic: Assignment ---
        async function startArrangement() {
            if (!isGridGenerated) return;
            if (isSwapMode) toggleSwapMode();

            pushHistory();

            const seats = document.querySelectorAll('.seat');
            let availableIndices = [];
            let lockedNames = [];

            seats.forEach((seat, i) => {
                const val = seat.querySelector('input').value.trim();
                if (seat.classList.contains('is-disabled')) return;
                if (seat.classList.contains('is-locked') && val) {
                    lockedNames.push(val);
                } else {
                    availableIndices.push(i);
                }
            });

            let students = getStudentList();
            if (!students) return;

            let toAssign = students.filter(s => !lockedNames.includes(s));

            if (toAssign.length > availableIndices.length) {
                showAlert("ì¢Œì„ ë¶€ì¡±", `ë‚¨ì€ ìë¦¬: ${availableIndices.length}ê°œ<br>í•™ìƒ ìˆ˜: ${toAssign.length}ëª…`);
                return;
            }

            // Dynamic Loading Text
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            overlay.classList.add('active');
            
            loadingText.innerText = "í•™ìƒ ëª…ë‹¨ ë¶„ì„ ì¤‘...";
            await new Promise(r => setTimeout(r, 600));
            loadingText.innerText = "ë°°ì¹˜ ìµœì í™” ì§„í–‰ ì¤‘...";
            await new Promise(r => setTimeout(r, 800));

            const shuffled = shuffle(toAssign);
            
            const layoutMode = document.querySelector('input[name="layout"]:checked').value;
            const finalAssignments = {}; // Map<SeatIndex, StudentName>

            if (layoutMode === 'group') {
                // [Modified] Group Mode: Round-Robin Distribution
                const groupMap = {}; // { groupId: [seatIndex, seatIndex...] }
                
                availableIndices.forEach(idx => {
                    const gId = seats[idx].dataset.group;
                    // If simple layout changed but dataset not updated (edge case), handle gracefully
                    if (gId !== undefined) {
                        if(!groupMap[gId]) groupMap[gId] = [];
                        groupMap[gId].push(idx);
                    } else {
                        // Fallback for seats without group ID
                        if(!groupMap['default']) groupMap['default'] = [];
                        groupMap['default'].push(idx);
                    }
                });

                const gKeys = Object.keys(groupMap).sort((a,b) => Number(a) - Number(b));
                let currentG = 0;

                shuffled.forEach(student => {
                    // Try to find a group with space, starting round-robin
                    let placed = false;
                    for(let i=0; i<gKeys.length; i++) {
                        const targetG = gKeys[(currentG + i) % gKeys.length];
                        if (groupMap[targetG].length > 0) {
                            const seatIdx = groupMap[targetG].shift(); // Take first slot
                            finalAssignments[seatIdx] = student;
                            currentG = (currentG + i + 1) % gKeys.length; // Next student goes to next group
                            placed = true;
                            break;
                        }
                    }
                });

            } else {
                // Linear Logic (Solo/Pair) - Fill from front (index 0)
                availableIndices.forEach((seatIdx, i) => {
                    if (i < shuffled.length) {
                        finalAssignments[seatIdx] = shuffled[i];
                    }
                });
            }
            
            // Apply to DOM
            seats.forEach(s => {
                s.classList.remove('pop-animation');
                if(!s.classList.contains('is-locked')) s.classList.remove('is-assigned');
            });

            availableIndices.forEach((idx, i) => { // Use i for animation delay calculation
                const seat = seats[idx];
                const input = seat.querySelector('input');
                const student = finalAssignments[idx];

                if (student) {
                    input.value = student;
                    seat.classList.add('is-assigned');
                    seat.style.animationDelay = `${i * 0.05}s`;
                    seat.classList.add('pop-animation');
                } else {
                    input.value = "";
                    seat.classList.remove('is-assigned');
                }
                adjustFontSize(input);
            });

            overlay.classList.remove('active');
            document.getElementById('step2-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('printBtn').classList.remove('hidden');
            updateStatus();
            autoSave();
            
            setTimeout(fireConfetti, 500);
        }

        // [Feature] Confetti Effect
        function fireConfetti() {
            const colors = ['#3182F6', '#ff9e2c', '#fa4646', '#27c076', '#a855f7'];
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            
            const createParticle = (x, y) => {
                const p = document.createElement('div');
                p.className = 'confetti';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(p);

                const angle = Math.random() * Math.PI * 2;
                const velocity = 2 + Math.random() * 4;
                let posX = x, posY = y;
                let velX = Math.cos(angle) * velocity;
                let velY = Math.sin(angle) * velocity;
                let opacity = 1;

                const animate = () => {
                    velY += 0.1;
                    posX += velX;
                    posY += velY;
                    opacity -= 0.015;
                    p.style.left = posX + 'px';
                    p.style.top = posY + 'px';
                    p.style.opacity = opacity;
                    if (opacity > 0) requestAnimationFrame(animate);
                    else p.remove();
                };
                requestAnimationFrame(animate);
            };

            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;
            for(let i=0; i<80; i++) createParticle(cx, cy);
        }

        function getStudentList() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            let list = [];

            if (mode === 'number') {
                const total = parseInt(document.getElementById('totalCount').value);
                if (!total || total < 1) { showAlert("ì…ë ¥ í™•ì¸", "ì´ ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return null; }
                const exStr = document.getElementById('excludeNumbers').value;
                const excludes = exStr.split(',').map(s => s.trim());
                for (let i = 1; i <= total; i++) {
                    if (!excludes.includes(String(i))) list.push(String(i));
                }
            } else {
                const text = document.getElementById('nameList').value;
                if (!text.trim()) { showAlert("ì…ë ¥ í™•ì¸", "í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return null; }
                list = text.split(/[,\n]+/).map(s => s.trim()).filter(s => s);
            }
            return list;
        }

        function cleanNames() {
            const area = document.getElementById('nameList');
            const raw = area.value;
            if(!raw.trim()) return;
            const clean = raw.split(/[\s,]+/).map(s => s.trim()).filter(s => s).join('\n');
            area.value = clean;
            autoSave();
            showToast("ëª…ë‹¨ì´ ê¹”ë”í•˜ê²Œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤");
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // --- Data Persistence ---
        function autoSave() {
            if (!isGridGenerated) return;
            // Get selected layout
            const layoutRadios = document.getElementsByName('layout');
            let layoutMode = 'pair';
            for(const r of layoutRadios) if(r.checked) layoutMode = r.value;

            const data = {
                layoutMode: layoutMode,
                // Layout specific data
                soloTotal: document.getElementById('soloTotal').value,
                soloCols: document.getElementById('soloCols').value,
                groupTotal: document.getElementById('groupTotal').value,
                groupCount: document.getElementById('groupCount').value,
                
                rows: document.getElementById('rows').value,
                cols: document.getElementById('cols').value,
                groups: document.getElementById('groups').value,
                
                totalCount: document.getElementById('totalCount').value,
                exclude: document.getElementById('excludeNumbers').value,
                names: document.getElementById('nameList').value,
                mode: document.querySelector('input[name="mode"]:checked').value,
                seats: Array.from(document.querySelectorAll('.seat')).map(s => ({
                    val: s.querySelector('input').value,
                    dis: s.classList.contains('is-disabled'),
                    lock: s.classList.contains('is-locked'),
                    assign: s.classList.contains('is-assigned')
                }))
            };
            localStorage.setItem(`school_seat_v6_class${currentClassId}`, JSON.stringify(data));
            updateTabIndicators();
        }

        function loadState(classId) {
            const raw = localStorage.getItem(`school_seat_v6_class${classId}`);
            if (!raw) {
                isGridGenerated = false;
                document.getElementById('seatGrid').innerHTML = '';
                document.getElementById('step2-container').classList.add('hidden');
                document.getElementById('step3-container').classList.add('hidden');
                document.getElementById('action-area').classList.add('hidden');
                document.getElementById('step1-container').classList.remove('collapsed');
                return;
            }
            try {
                const d = JSON.parse(raw);
                
                // Restore Layout Mode
                const layoutMode = d.layoutMode || 'pair';
                const layoutRadios = document.getElementsByName('layout');
                for(const r of layoutRadios) {
                    if(r.value === layoutMode) r.checked = true;
                }
                toggleLayoutSettings();

                // Restore Inputs
                if(d.soloTotal) document.getElementById('soloTotal').value = d.soloTotal;
                if(d.soloCols) document.getElementById('soloCols').value = d.soloCols;
                if(d.groupTotal) document.getElementById('groupTotal').value = d.groupTotal;
                if(d.groupCount) document.getElementById('groupCount').value = d.groupCount;
                
                document.getElementById('rows').value = d.rows;
                document.getElementById('cols').value = d.cols;
                document.getElementById('groups').value = d.groups || 1;
                document.getElementById('totalCount').value = d.totalCount;
                document.getElementById('excludeNumbers').value = d.exclude;
                document.getElementById('nameList').value = d.names;
                
                const radio = document.querySelector(`input[name="mode"][value="${d.mode}"]`);
                if(radio) { radio.checked = true; toggleMode(); }

                generateGrid(true);

                const seats = document.querySelectorAll('.seat');
                d.seats.forEach((sd, i) => {
                    if (seats[i]) {
                        const s = seats[i];
                        const inp = s.querySelector('input');
                        inp.value = sd.val;
                        adjustFontSize(inp);
                        if(sd.dis) { s.classList.add('is-disabled'); inp.disabled = true; }
                        if(sd.lock) s.classList.add('is-locked');
                        if(sd.assign) {
                            s.classList.add('is-assigned');
                            document.getElementById('printBtn').classList.remove('hidden');
                        }
                    }
                });
                updateStatus();
                document.getElementById('step1-container').classList.add('collapsed');
            } catch(e) { console.error(e); }
        }

        // --- Backup & Restore ---
        function backupData() {
            const backup = {};
            for(let i=1; i<=8; i++) {
                const key = `school_seat_v6_class${i}`;
                const data = localStorage.getItem(key);
                if(data) backup[key] = JSON.parse(data);
            }
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `ìë¦¬ë°°ì¹˜_ë°±ì—…_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function handleRestoreFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    const count = Object.keys(backup).length;
                    
                    const ok = await showConfirm("ë°ì´í„° ë³µì›", `ì´ ${count}ê°œ ë°˜ì˜ ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`);
                    if(!ok) { input.value = ''; return; }
                    
                    for(const key in backup) {
                        if(key.startsWith('school_seat_v6_class')) {
                            localStorage.setItem(key, JSON.stringify(backup[key]));
                        }
                    }
                    
                    showToast("ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    updateTabIndicators();
                    loadState(currentClassId);
                } catch(err) {
                    showAlert("ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        async function clearClassData() {
            const ok = await showConfirm("ë°ì´í„° ì´ˆê¸°í™”", `í˜„ì¬ [${currentClassId}ë°˜]ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if(ok) {
                localStorage.removeItem(`school_seat_v6_class${currentClassId}`);
                location.reload();
            }
        }

        async function clearOnlyAssigned() {
            const ok = await showConfirm("ê²°ê³¼ ì´ˆê¸°í™”", "ê³ ì •ì„ì„ ì œì™¸í•œ ë°°ì • ê²°ê³¼ë§Œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!ok) return;
            pushHistory();
            document.querySelectorAll('.seat').forEach(s => {
                if(!s.classList.contains('is-locked') && !s.classList.contains('is-disabled')) {
                    s.querySelector('input').value = "";
                    s.classList.remove('is-assigned');
                }
            });
            updateStatus();
            autoSave();
            document.getElementById('printBtn').classList.add('hidden');
        }

        function toggleCard(id) { document.getElementById(id).classList.toggle('collapsed'); }

        function toggleMode() {
            const isNum = document.querySelector('input[name="mode"]:checked').value === 'number';
            document.getElementById('mode-number').classList.toggle('hidden', !isNum);
            document.getElementById('mode-name').classList.toggle('hidden', isNum);
            document.getElementById('cleanBtn').classList.toggle('hidden', isNum);
            autoSave();
        }

        // [Fix] ì¸ì‡„ ê¸°ëŠ¥ ê°œì„  (ì•ˆì •ì„± í™•ë³´)
        function printResult() {
            // ë‚ ì§œ ì„¤ì •
            const d = new Date();
            document.getElementById('printDate').innerText = `${currentClassId}ë°˜ ìë¦¬ ë°°ì¹˜ - ${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
            
            // ì•ˆë‚´ ë©”ì‹œì§€
            showToast(" ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤...");
            
            // ë¸Œë¼ìš°ì € ë Œë”ë§ ëŒ€ê¸° í›„ ì¸ì‡„ ì‹¤í–‰
            setTimeout(() => {
                try {
                    window.focus(); // ì°½ í¬ì»¤ìŠ¤ í™•ë³´
                    window.print(); // ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ í˜¸ì¶œ
                } catch (e) {
                    showAlert("ì¸ì‡„ ì˜¤ë¥˜", "ë¸Œë¼ìš°ì € ì„¤ì • ë¬¸ì œë¡œ ì¸ì‡„ ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>Ctrl+P (Mac: Cmd+P)ë¥¼ ëˆŒëŸ¬ ì§ì ‘ ì¸ì‡„í•´ì£¼ì„¸ìš”.");
                }
            }, 800); // 0.8ì´ˆ ëŒ€ê¸°
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function showConfirm(title, msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalMessage').innerHTML = msg;
                const actions = document.getElementById('modalActions');
                actions.innerHTML = '';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'modal-btn cancel';
                cancelBtn.innerText = 'ì·¨ì†Œ';
                cancelBtn.onclick = () => { modal.classList.remove('active'); resolve(false); };
                
                const okBtn = document.createElement('button');
                okBtn.className = 'modal-btn confirm';
                okBtn.innerText = 'í™•ì¸';
                okBtn.onclick = () => { modal.classList.remove('active'); resolve(true); };
                
                actions.appendChild(cancelBtn);
                actions.appendChild(okBtn);
                modal.classList.add('active');
            });
        }

        function showAlert(title, msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalMessage').innerHTML = msg;
                const actions = document.getElementById('modalActions');
                actions.innerHTML = '';
                
                const okBtn = document.createElement('button');
                okBtn.className = 'modal-btn confirm';
                okBtn.innerText = 'í™•ì¸';
                okBtn.onclick = () => { modal.classList.remove('active'); resolve(true); };
                
                actions.appendChild(okBtn);
                modal.classList.add('active');
            });
        }
    </script>
</body>
</html>
